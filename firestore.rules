rules_version = '2';
// ChampBase Firestore – production rules.
// Deploy: firebase deploy --only firestore:rules
// Workouts/leaderboards: create only gym owner or event creator. Scores: athlete can update own score.

service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    // Collection group "member_roles": requise pour getGymsWhereUserCanCreateWod (coach/admin voient leurs gyms)
    match /{path=**}/member_roles/{userId} {
      allow read: if true;
      allow write: if false;
    }

    // users: any authenticated user can read; write only own
    match /users/{uid} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.uid == uid;

      // benchmark_results: owner read/write all; others read only if public (isPublic != false; missing = public)
      match /benchmark_results/{resultId} {
        allow read: if request.auth != null && (
          request.auth.uid == uid
          || resource.data.get('isPublic', true) == true
        );
        allow create, update, delete: if request.auth != null && request.auth.uid == uid;
      }

      // skills: compétences checklist – owner read/write only
      match /skills/{movementId} {
        allow read, write: if request.auth != null && request.auth.uid == uid;
      }

      // skill_visibility: visibilité par catégorie – owner read/write; others read if isPublic
      match /skill_visibility/{categoryId} {
        allow read: if request.auth != null && (
          request.auth.uid == uid
          || resource.data.get('isPublic', true) == true
        );
        allow create, update, delete: if request.auth != null && request.auth.uid == uid;
      }
    }

    // benchmarks: public read; write only organizer (user with roles.organizer)
    match /benchmarks/{benchmarkId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.organizer == true;
    }

    // gyms: public read; write only if request.auth.uid == ownerUid
    match /gyms/{gymId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.ownerUid == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.ownerUid == request.auth.uid;

      // member_roles: rôles par membre (admin, coach); lecture publique pour afficher le rôle sur le profil; seul le propriétaire du gym peut écrire
      match /member_roles/{userId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null
          && get(/databases/$(database)/documents/gyms/$(gymId)).data.ownerUid == request.auth.uid;
      }

      // WODs subcollection: gym owner, admin ou coach du gym peuvent créer/éditer/supprimer
      // exists() évite l'erreur quand le doc member_roles n'existe pas pour l'utilisateur
      match /wods/{wodId} {
        allow read: if request.auth != null && (
          resource.data.isPublished == true
          || resource.data.createdByUid == request.auth.uid
          || get(/databases/$(database)/documents/gyms/$(gymId)).data.ownerUid == request.auth.uid
          || (exists(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)).data.get('admin', false) == true)
          || (exists(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)).data.get('coach', false) == true)
        );
        allow create: if request.auth != null
          && (
            get(/databases/$(database)/documents/gyms/$(gymId)).data.ownerUid == request.auth.uid
            || (exists(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)).data.get('admin', false) == true)
            || (exists(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)).data.get('coach', false) == true)
          )
          && request.resource.data.createdByUid == request.auth.uid
          && request.resource.data.keys().hasAll(['title', 'scoreType', 'createdByUid', 'isPublished'])
          && request.resource.data.scoreType in ['time', 'reps', 'weight']
          && request.resource.data.isPublished is bool;
        allow update, delete: if request.auth != null
          && (
            get(/databases/$(database)/documents/gyms/$(gymId)).data.ownerUid == request.auth.uid
            || (exists(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)).data.get('admin', false) == true)
            || (exists(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)).data.get('coach', false) == true)
          );

        // scores subcollection: doc id = athlete uid; athlete create/update own; owner/admin/coach can delete
        match /scores/{uid} {
          allow read: if request.auth != null;
          allow create: if request.auth != null && request.auth.uid == uid;
          allow update: if request.auth != null && request.auth.uid == uid;
          allow delete: if request.auth != null
            && (
              get(/databases/$(database)/documents/gyms/$(gymId)).data.ownerUid == request.auth.uid
              || (exists(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)).data.get('admin', false) == true)
              || (exists(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(gymId)/member_roles/$(request.auth.uid)).data.get('coach', false) == true)
            );
        }
      }

      // Gym activity feed: gyms/{gymId}/feed/{scoreId} – read any authenticated; create/update (athlete or trophy toggle)
      match /feed/{scoreId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null && request.resource.data.athleteUid == request.auth.uid;
        // Update: post owner can update any field; any authenticated user can update only trophies (toggle reaction)
        allow update: if request.auth != null && (
          resource.data.athleteUid == request.auth.uid
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['trophies'])
        );
        allow delete: if request.auth != null && resource.data.athleteUid == request.auth.uid;
      }

      // Feed posts (legacy): created/updated only by Cloud Function; read allowed
      match /feedPosts/{postId} {
        allow read: if true;
        allow create, update, delete: if false;

        match /replies/{replyId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null
            && request.resource.data.userId == request.auth.uid
            && request.resource.data.userName is string
            && request.resource.data.text is string;
          allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
        }

        match /stars/{userId} {
          allow read: if request.auth != null;
          allow create, update: if request.auth != null
            && request.auth.uid == userId
            && request.resource.data.rating is number
            && request.resource.data.rating >= 1
            && request.resource.data.rating <= 5;
          allow delete: if request.auth != null && request.auth.uid == userId;
        }
      }
    }

    // events: read if published (isPublic or status) OR user is creator; write only if request.auth.uid == createdByUid
    match /events/{eventId} {
      allow read: if resource.data.isPublic == true
        || resource.data.status == 'published'
        || (request.auth != null && resource.data.createdByUid == request.auth.uid);
      allow create: if request.auth != null && request.resource.data.createdByUid == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.createdByUid == request.auth.uid;
    }

    // workouts: read for MVP (public); create/update/delete: gym owner/admin/coach or event creator
    match /workouts/{workoutId} {
      allow read: if true;
      allow create: if request.auth != null
        && request.resource.data.gymId is string
        && (
          (request.resource.data.gymId != ''
            && (
              get(/databases/$(database)/documents/gyms/$(request.resource.data.gymId)).data.ownerUid == request.auth.uid
              || (exists(/databases/$(database)/documents/gyms/$(request.resource.data.gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(request.resource.data.gymId)/member_roles/$(request.auth.uid)).data.get('admin', false) == true)
              || (exists(/databases/$(database)/documents/gyms/$(request.resource.data.gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(request.resource.data.gymId)/member_roles/$(request.auth.uid)).data.get('coach', false) == true)
            ))
          || (request.resource.data.eventId != null
            && request.resource.data.eventId is string
            && get(/databases/$(database)/documents/events/$(request.resource.data.eventId)).data.createdByUid == request.auth.uid)
        );
      allow update, delete: if request.auth != null
        && (
          (resource.data.gymId != ''
            && (
              get(/databases/$(database)/documents/gyms/$(resource.data.gymId)).data.ownerUid == request.auth.uid
              || (exists(/databases/$(database)/documents/gyms/$(resource.data.gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(resource.data.gymId)/member_roles/$(request.auth.uid)).data.get('admin', false) == true)
              || (exists(/databases/$(database)/documents/gyms/$(resource.data.gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(resource.data.gymId)/member_roles/$(request.auth.uid)).data.get('coach', false) == true)
            ))
          || (resource.data.eventId != null && get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.createdByUid == request.auth.uid)
        );
    }

    // leaderboards: read if isPublic OR event creator; create/update/delete: gym owner/admin/coach or event creator
    match /leaderboards/{leaderboardId} {
      allow read: if resource.data.isPublic == true
        || (request.auth != null && resource.data.eventId != null && get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.createdByUid == request.auth.uid);
      allow create: if request.auth != null
        && (
          (request.resource.data.workoutId != null && request.resource.data.workoutId is string
            && (
              (get(/databases/$(database)/documents/workouts/$(request.resource.data.workoutId)).data.gymId != ''
                && (
                  get(/databases/$(database)/documents/gyms/$(get(/databases/$(database)/documents/workouts/$(request.resource.data.workoutId)).data.gymId)).data.ownerUid == request.auth.uid
                  || (exists(/databases/$(database)/documents/gyms/$(get(/databases/$(database)/documents/workouts/$(request.resource.data.workoutId)).data.gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(get(/databases/$(database)/documents/workouts/$(request.resource.data.workoutId)).data.gymId)/member_roles/$(request.auth.uid)).data.get('admin', false) == true)
                  || (exists(/databases/$(database)/documents/gyms/$(get(/databases/$(database)/documents/workouts/$(request.resource.data.workoutId)).data.gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(get(/databases/$(database)/documents/workouts/$(request.resource.data.workoutId)).data.gymId)/member_roles/$(request.auth.uid)).data.get('coach', false) == true)
                ))
              || (get(/databases/$(database)/documents/workouts/$(request.resource.data.workoutId)).data.eventId != null
                && get(/databases/$(database)/documents/events/$(get(/databases/$(database)/documents/workouts/$(request.resource.data.workoutId)).data.eventId)).data.createdByUid == request.auth.uid)
            ))
          || (request.resource.data.workoutId == null
            && request.resource.data.eventId != null
            && request.resource.data.eventId is string
            && get(/databases/$(database)/documents/events/$(request.resource.data.eventId)).data.createdByUid == request.auth.uid)
        );
      allow update, delete: if request.auth != null
        && (
          (resource.data.gymId != ''
            && (
              get(/databases/$(database)/documents/gyms/$(resource.data.gymId)).data.ownerUid == request.auth.uid
              || (exists(/databases/$(database)/documents/gyms/$(resource.data.gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(resource.data.gymId)/member_roles/$(request.auth.uid)).data.get('admin', false) == true)
              || (exists(/databases/$(database)/documents/gyms/$(resource.data.gymId)/member_roles/$(request.auth.uid)) && get(/databases/$(database)/documents/gyms/$(resource.data.gymId)/member_roles/$(request.auth.uid)).data.get('coach', false) == true)
            ))
          || (resource.data.eventId != null && get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.createdByUid == request.auth.uid)
        );
    }

    // scores (top-level): TEMP DEBUG – allow read/write when authenticated (revert for production)
    match /scores/{scoreId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }

    // registrations: user can read own; event creator can read all for their event; user can read pending (userId=='') where email matches (to claim).
    match /registrations/{regId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid
        || (resource.data.eventId != null && get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.createdByUid == request.auth.uid)
        || (resource.data.userId == '' && resource.data.email != null && resource.data.email == request.auth.token.email)
      );
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid
        || (request.resource.data.eventId != null && get(/databases/$(database)/documents/events/$(request.resource.data.eventId)).data.createdByUid == request.auth.uid)
      );
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid
        || (resource.data.eventId != null && get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.createdByUid == request.auth.uid)
        || (resource.data.userId == '' && resource.data.email != null && resource.data.email == request.auth.token.email && request.resource.data.userId == request.auth.uid)
      );
      allow delete: if request.auth != null && (
        resource.data.userId == request.auth.uid
        || (resource.data.eventId != null && get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.createdByUid == request.auth.uid)
      );
    }
  }
}
